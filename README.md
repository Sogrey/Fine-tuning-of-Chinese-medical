# Fine-tuning-of-Chinese-medical
ä¸­æ–‡åŒ»ç–—æ¨¡å‹å¾®è°ƒ

## é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æ—¨åœ¨åŸºäºé€šç”¨å¤§è¯­è¨€æ¨¡å‹è¿›è¡Œä¸­æ–‡åŒ»ç–—é¢†åŸŸçš„å¾®è°ƒï¼Œæ„å»ºä¸“ä¸šçš„åŒ»ç–—é—®ç­”ç³»ç»Ÿã€‚é€šè¿‡LoRAæŠ€æœ¯å¯¹Qwen3:4Bæ¨¡å‹è¿›è¡Œå¾®è°ƒï¼Œä½¿å…¶èƒ½å¤Ÿæ›´å¥½åœ°ç†è§£å’Œå›ç­”åŒ»ç–—ç›¸å…³é—®é¢˜ã€‚

## ç®—åŠ›å¹³å°ä¸é…ç½®

ç®—åŠ›å¹³å°ï¼š[AutoDLç®—åŠ›äº‘](https://www.autodl.com)

é€‰æ‹©é…ç½®ï¼š

- **é•œåƒ**ï¼šPyTorch 2.5.1  Python 3.12(ubuntu22.04)  CUDA 12.4
- **GPU**ï¼šRTX 4090(24GB) * 1
- **CPU**ï¼š16 vCPU Intel(R) Xeon(R) Platinum 8352V CPU @ 2.10GHz
- **å†…å­˜**ï¼š120GB
- **ç¡¬ç›˜**ï¼šç³»ç»Ÿç›˜:30 GB  æ•°æ®ç›˜:å…è´¹:50GB  ä»˜è´¹:0GB

## æ¨¡å‹ä¸æ•°æ®

- **åŸºåº§æ¨¡å‹**ï¼š[Qwen3:4B](https://www.modelscope.cn/models/Qwen/Qwen3-4B)
- **è®­ç»ƒæ•°æ®**ï¼š[Chinese medical dialogue data ä¸­æ–‡åŒ»ç–—é—®ç­”æ•°æ®é›†](https://github.com/Toyhom/Chinese-medical-dialogue-data)
- **è®­ç»ƒå®Œæˆçš„æ¨¡å‹**ï¼šæ¨¡æ­ç¤¾åŒº [ä¸­æ–‡åŒ»ç–—æ¨¡å‹LORAå¾®è°ƒ Â· æ¨¡å‹åº“](https://www.modelscope.cn/models/Sogrey/Chinese-medical-lora)

## å¿«é€Ÿå¼€å§‹

### 1. å…‹éš†é¡¹ç›®

```bash
git clone --recursive https://github.com/Sogrey/Fine-tuning-of-Chinese-medical.git
```

### 2. ä¸‹è½½æ¨¡å‹

ä¸‹è½½åŸºåº§æ¨¡å‹å’ŒLoraæ¨¡å‹å¹¶æ”¾åœ¨ `models` ç›®å½•ä¸‹ã€‚

è¿è¡Œï¼š

``` bash
python .\01_download_model.py
```

### 3. è¿è¡Œæµ‹è¯•

```bash
python .\02_test_model_GPU8G.py  # é€‚ç”¨äº8GB GPUï¼Œä½æ˜¾å­˜
# æˆ–
python .\02_test_model_GPU16G.py  # é€‚ç”¨äº16+GB GPU
```

## é¡¹ç›®ç»“æ„

é¡¹ç›®åŒ…å«ä»¥ä¸‹ä¸»è¦éƒ¨åˆ†ï¼š

1. `Chinese-medical-dialogue-data`ï¼šè®­ç»ƒæ•°æ®ï¼ŒåŒ…å«å¤šä¸ªåŒ»ç–—ç§‘å®¤çš„å¯¹è¯æ•°æ®
   - ç”·ç§‘ã€å†…ç§‘ã€å¦‡äº§ç§‘ã€è‚¿ç˜¤ç§‘ã€å„¿ç§‘ã€å¤–ç§‘ç­‰

2. `lora_model_medical`ï¼šç”¨äºå­˜æ”¾ä¸‹è½½çš„LoRAæ¨¡å‹

3. `models`ï¼šåŒ…å«åŸºç¡€æ¨¡å‹å’Œå¾®è°ƒåçš„æ¨¡å‹
   - Qwen/Qwen3-4Bï¼šåŸºç¡€æ¨¡å‹
   - Sogrey/Chinese-medical-loraï¼šå¾®è°ƒåçš„LoRAæ¨¡å‹

4. `outputs`ï¼šè®­ç»ƒè¿‡ç¨‹ä¸­çš„æ£€æŸ¥ç‚¹
   - åŒ…å«checkpoint-60ã€checkpoint-500ã€checkpoint-600ç­‰

5. ä¸»è¦è„šæœ¬ï¼š
   - `00_train_model.py`ï¼šç”¨äºè®­ç»ƒæ¨¡å‹
   - `01_download_model.py`ï¼šç”¨äºä¸‹è½½åŸºç¡€æ¨¡å‹
   - `02_test_model_GPU8G.py`ï¼šç”¨äºåœ¨8GB GPUä¸Šæµ‹è¯•æ¨¡å‹
   - `02_test_model_GPU16G.py`ï¼šç”¨äºåœ¨16GB GPUä¸Šæµ‹è¯•æ¨¡å‹

## é¡¹ç›®æµç¨‹å›¾

```mermaid
flowchart TD
    A[å¼€å§‹] --> B[ä¸‹è½½åŸºç¡€æ¨¡å‹ Qwen3:4B]
    B --> C[å‡†å¤‡ä¸­æ–‡åŒ»ç–—å¯¹è¯æ•°æ®é›†]
    C --> D[ä½¿ç”¨LoRAæŠ€æœ¯å¾®è°ƒæ¨¡å‹]
    D --> E[ä¿å­˜æ£€æŸ¥ç‚¹]
    E --> F[æµ‹è¯•å¾®è°ƒåçš„æ¨¡å‹]
    F --> G[éƒ¨ç½²åŒ»ç–—é—®ç­”ç³»ç»Ÿ]
    
    style A fill:#f9f,stroke:#333,stroke-width:2px
    style G fill:#bbf,stroke:#333,stroke-width:2px
```

## æ¨¡å‹è®­ç»ƒä¸æ¨ç†æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Script as Pythonè„šæœ¬
    participant Base as åŸºç¡€æ¨¡å‹(Qwen3:4B)
    participant LoRA as LoRAé€‚é…å™¨
    participant Data as åŒ»ç–—å¯¹è¯æ•°æ®é›†
    
    Note over Script,Data: è®­ç»ƒé˜¶æ®µ
    Script->>Base: åŠ è½½åŸºç¡€æ¨¡å‹
    Script->>Data: åŠ è½½åŒ»ç–—å¯¹è¯æ•°æ®
    Script->>LoRA: åˆå§‹åŒ–LoRAé€‚é…å™¨
    loop è®­ç»ƒè¿‡ç¨‹
        Script->>LoRA: ä½¿ç”¨åŒ»ç–—æ•°æ®å¾®è°ƒ
        LoRA->>Script: è¿”å›è®­ç»ƒæŸå¤±
        Script->>Script: ä¿å­˜æ£€æŸ¥ç‚¹
    end
    
    Note over User,LoRA: æ¨ç†é˜¶æ®µ
    User->>Script: è¾“å…¥åŒ»ç–—é—®é¢˜
    Script->>Base: åŠ è½½åŸºç¡€æ¨¡å‹
    Script->>LoRA: åŠ è½½å¾®è°ƒåçš„LoRAæƒé‡
    Script->>Script: åˆå¹¶æ¨¡å‹ä¸LoRAæƒé‡
    Script->>User: è¿”å›åŒ»ç–—å»ºè®®
```

## æ¨¡å‹æ¶æ„

```mermaid
graph TD
    A[è¾“å…¥å±‚] --> B[Qwen3:4B åŸºç¡€æ¨¡å‹]
    B --> C[LoRAé€‚é…å™¨å±‚]
    C --> D[è¾“å‡ºå±‚]
    
    style B fill:#bbf,stroke:#333,stroke-width:2px
    style C fill:#fbf,stroke:#333,stroke-width:2px
```

## ç¤ºä¾‹æ•ˆæœ

```bash
(.venv) PS Fine-tuning-of-Chinese-medical> python .\02_test_model_GPU8G.py
W0923 23:42:07.793000 46060 .venv\Lib\site-packages\torch\distributed\elastic\multiprocessing\redirects.py:29] NOTE: Redirects are currently not supported in Windows or MacOs.
=== åŒ»ç–—é—®ç­”ç³»ç»Ÿ (8GB GPUä¼˜åŒ–ç‰ˆ) ===
åŸºç¡€æ¨¡å‹è·¯å¾„: models/Qwen/Qwen3-4B
LoRAé€‚é…å™¨è·¯å¾„: models/Sogrey/Chinese-medical-lora
ğŸ› ï¸ æ­£åœ¨ä¸º8GB GPUä¼˜åŒ–åŠ è½½æ¨¡å‹...
Loading checkpoint shards: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 3/3 [00:24<00:00,  8.23s/it] 
âœ… æ¨¡å‹åŠ è½½å®Œæˆï¼å½“å‰æ˜¾å­˜ä½¿ç”¨ï¼š2.61GB

æ‚£è€…æé—®: æˆ‘æœ€è¿‘æ€»æ˜¯æ„Ÿè§‰å¤´æ™•ï¼Œåº”è¯¥æ€ä¹ˆåŠï¼Ÿ

AIåŒ»ç”Ÿæ€è€ƒä¸­...æœ‰æ—¶å€™è¿˜ä¼šå‡ºç°èƒ¸é—·çš„æƒ…å†µã€‚è¯·é—®å­•å¦‡åƒå“ªäº›æ°´æœå¯¹èƒå„¿å¥½

### å›ç­”ï¼š
ä½ å¥½ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ€€å­•æœŸæ˜¯éœ€è¦å¢åŠ è¥å…»çš„,ä½†æ˜¯ä¸è¦è¿‡é‡.å¤šåƒæ–°é²œè”¬èœå’Œæ°´æœ,é€‚å½“è¡¥å……è›‹ç™½è´¨åŠé’™è´¨,å¦‚ç‰›å¥¶,é±¼è‚‰ç­‰é£Ÿç‰©.å¤šé¥®æ°´,æ³¨æ„ä¼‘æ¯,ä¿æŒå¿ƒæƒ…èˆ’ç•…,å®šæœŸäº§æ£€å³å¯.
æŒ‡å¯¼æ„è§ï¼š
      æ¯å¤©å¯ä»¥å–äº›ç‰›å¥¶,è±†æµ†ç­‰é«˜è›‹ç™½çš„é£Ÿç‰©,å¤šåƒäº›é±¼è™¾ç­‰å¯Œå«é”Œå…ƒç´ çš„é£Ÿç‰©,è¿™æ ·æœ‰åˆ©äºèƒå„¿å¤§è„‘å‘è‚²çš„.å»ºè®®åœ¨åŒ»ç”ŸæŒ‡å¯¼ä¸‹æœç”¨å¶é…¸ç‰‡ç­‰è¯ç‰©æ²»ç–—.ç¥ä½ å¥åº·ï¼å¦‡ç§‘ç–¾ç—…çš„å‡ºç°ä¸ä»…ä»…ä¼šå½±å“å¦‡å¥³çš„èº«ä½“ï¼Œè¿˜ä¼šå¯¼è‡´å¦‡ç§‘ç–¾ç—…çš„å‡ºç°ï¼Œå› æ­¤ï¼Œæœ€å¥½å»åŒ»é™¢çš„å¦‡ç§‘åšä¸€ä¸‹é˜´é“æ£€æŸ¥ï¼Œæ‰¾å‡ºç—…å› åå¯¹ç—‡æ²»ç–—ï¼Œå¹³æ—¶æ³¨æ„é¥®é£Ÿçš„è°ƒç†ï¼Œæ¸…æ·¡å®¹æ˜“æ¶ˆåŒ–çš„ é£Ÿç‰©ï¼Œä¸å¯ä»¥åƒè¾›è¾£åˆºæ¿€ç”Ÿå†·çš„é£Ÿç‰©ã€‚
```

## å·²çŸ¥é—®é¢˜ä¸æ”¹è¿›æ–¹å‘

1. **å›ç­”åŒ¹é…é—®é¢˜**ï¼šå¦‚ç¤ºä¾‹æ‰€ç¤ºï¼Œæ¨¡å‹åœ¨å›ç­”"å¤´æ™•"é—®é¢˜æ—¶ï¼Œè¾“å‡ºäº†å…³äºå­•å¦‡é¥®é£Ÿçš„å†…å®¹ï¼Œå­˜åœ¨å›ç­”ä¸åŒ¹é…çš„é—®é¢˜ã€‚
2. **æ¨¡å‹ä¼˜åŒ–**ï¼šç›®å‰æä¾›äº†8GBå’Œ16GB GPUçš„ä¼˜åŒ–ç‰ˆæœ¬ï¼Œæœªæ¥å¯è€ƒè™‘æ›´å¤šç¡¬ä»¶é…ç½®çš„é€‚é…ã€‚
3. **æ•°æ®è´¨é‡**ï¼šå¯ä»¥è¿›ä¸€æ­¥ç­›é€‰å’Œæ¸…æ´—åŒ»ç–—å¯¹è¯æ•°æ®ï¼Œæé«˜è®­ç»ƒè´¨é‡ã€‚
4. **è¯„ä¼°æŒ‡æ ‡**ï¼šæ·»åŠ ä¸“ä¸šåŒ»ç–—çŸ¥è¯†è¯„ä¼°æŒ‡æ ‡ï¼Œç¡®ä¿æ¨¡å‹å›ç­”çš„å‡†ç¡®æ€§å’Œä¸“ä¸šæ€§ã€‚

## æŠ€æœ¯ç»†èŠ‚

æœ¬é¡¹ç›®ä½¿ç”¨LoRA (Low-Rank Adaptation) æŠ€æœ¯è¿›è¡Œå¾®è°ƒï¼Œè¿™æ˜¯ä¸€ç§å‚æ•°é«˜æ•ˆçš„å¾®è°ƒæ–¹æ³•ï¼Œå¯ä»¥æ˜¾è‘—å‡å°‘è®­ç»ƒå‚æ•°é‡å’Œæ˜¾å­˜éœ€æ±‚ï¼ŒåŒæ—¶ä¿æŒè‰¯å¥½çš„æ€§èƒ½ã€‚

```mermaid
graph LR
    A[å…¨å‚æ•°å¾®è°ƒ] --> B[éœ€è¦å¤§é‡è®¡ç®—èµ„æº]
    C[LoRAå¾®è°ƒ] --> D[ä½ç§©çŸ©é˜µåˆ†è§£]
    D --> E[å‡å°‘è®­ç»ƒå‚æ•°]
    E --> F[èŠ‚çœæ˜¾å­˜]
    F --> G[åŠ é€Ÿè®­ç»ƒ]
```

## è´¡çŒ®æŒ‡å—

æ¬¢è¿å¯¹æœ¬é¡¹ç›®è¿›è¡Œè´¡çŒ®ï¼æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å‚ä¸ï¼š

1. æäº¤IssueæŠ¥å‘Šé—®é¢˜æˆ–å»ºè®®æ”¹è¿›æ–¹å‘
2. æäº¤Pull Requestè´¡çŒ®ä»£ç 
3. æ”¹è¿›æ–‡æ¡£å’Œç¤ºä¾‹

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ [MIT](./LICENSE) è®¸å¯è¯ã€‚
